##############################
# Configure networking and basic stats collection
##############################

- name: Find default netplan config
  find:
    paths: '/etc/netplan'
    patterns: '[0-9]*'
  register: default_netplan_config

- name: Remove default netplan config
  file:
    path: '{{ item.path }}'
    state: absent
  with_items: '{{ default_netplan_config.files }}'

- name: Install netplan config
  copy:
    src: netplan.yml
    dest: /etc/netplan/netplan.yaml
    owner: root
    group: root
    mode: '644'

- name: Write hostname file
  template:
    src: hostname
    dest: /etc/hostname
    mode: '0644'
  notify: hostname

- name: Install node-exporter
  apt:
    pkg:
      - 'prometheus-node-exporter'

##############################
# Configure server storage
##############################

- name: Install ZFS Ubuntu support
  apt:
    name:
      - zfs-dkms
      - zfsutils-linux

- name: Make storage root
  file:
    path: /storage
    state: directory
    owner: root
    group: root
    mode: '755'

##############################
# Turn on Apache httpd
##############################

- name: Install Apache httpd
  apt:
    name: apache2

- name: Enable httpd reverse proxy
  file:
    path: /etc/apache2/mods-enabled/{{ item }}.load
    src: ../mods-available/{{ item }}.load
    state: link
  with_items:
    - headers
    - proxy
    - proxy_http
    - proxy_http2
    - proxy_wstunnel
    - rewrite
    - ssl
    # TODO: Enable handler to restart Apache server

##############################
# Turn on Docker
##############################

- name: Get Docker upstream APT GPG key
  apt_key:
    id: '{{ docker_apt_key }}'
    keyserver: 'hkp://pool.sks-keyservers.net'
    state: present

- name: Configure Docker upstream APT repository
  apt_repository:
    repo: '{{ docker_repository }}'
    update_cache: True
    state: present

- name: Install Docker
  apt:
    pkg:
      - 'docker.io'
      - 'docker-compose'

- name: Add users to Docker usage group
  user:
    name: '{{ item }}'
    groups: 'docker'
    append: True
  with_items: '{{ docker_users }}'
  when: docker_users | length > 0

##############################
# Configure letsencrypt support
##############################

- name: Make directory for crypto material
  file:
    path: /storage/tls
    state: directory
    owner: root
    group: www-data
    mode: '2750'

- name: Install letsencrypt httpd config
  copy:
    src: httpd/letsencrypt.conf
    dest: /etc/apache2/conf-available
    mode: '644'

- name: Enable letsencrypt httpd config
  file:
    path: /etc/apache2/conf-enabled/letsencrypt.conf
    src: ../conf-available/letsencrypt.conf
    state: link

- name: Install letsencrypt renewal script
  copy:
    src: letsencrypt/gencerts
    dest: /usr/local/sbin
    mode: '750'

- name: Install letsencrypt renewal script systemd service
  copy:
    src: letsencrypt/gencerts.service
    dest: /etc/systemd/system
    mode: '644'
  notify:
    - 'enable letsencrypt gencerts'

- name: Install letsencrypt renewal script systemd timer
  copy:
    src: letsencrypt/gencerts.timer
    dest: /etc/systemd/system
    mode: '644'
  notify:
    - 'enable letsencrypt gencerts timer'

##############################
# Turn on prometheus
##############################

- name: Make prometheus storage volume
  docker_volume:
    name: prometheus

- name: Make prometheus config directory
  file:
    path: /config/prometheus
    state: directory
    owner: root
    group: adm
    mode: '751'

- name: Install prometheus config files
  copy:
    src: 'prometheus/{{ item }}'
    dest: /config/prometheus
    owner: root
    group: adm
    mode: '644'
  with_items:
    - prometheus.yml
    - node.rules
    - prober.rules
    - blackbox.yml

- name: Install prometheus httpd config
  copy:
    src: httpd/mon.conf
    dest: /etc/apache2/sites-available
    mode: '644'

- name: Enable prometheus httpd config
  file:
    path: /etc/apache2/sites-enabled/mon.conf
    src: ../sites-available/mon.conf
    state: link

##############################
# Turn on alertmanager
##############################

- name: Make alertmanager storage volume
  docker_volume:
    name: alertmanager

- name: Install alertmanager config
  copy:
    src: prometheus/alertmanager.yml
    dest: /config/prometheus
    owner: root
    group: nogroup  # alertmanager is hard-coded to run as nobody:nogroup
    mode: '640'

##############################
# Turn on grafana
##############################

- name: Make grafana storage volume
  docker_volume:
    name: grafana

- name: Install grafana config
  copy:
    src: grafana.ini
    dest: /config/grafana
    owner: root
    group: adm
    mode: '644'

- name: Install grafana httpd config
  copy:
    src: httpd/grafana.conf
    dest: /etc/apache2/sites-available
    mode: '644'

- name: Enable grafana httpd config
  file:
    path: /etc/apache2/sites-enabled/grafana.conf
    src: ../sites-available/grafana.conf
    state: link
